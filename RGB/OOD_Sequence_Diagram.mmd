sequenceDiagram
    participant Main as Main
    participant Parser as GameInputParser
    participant Battle as Battle
    participant T1 as Troop1
    participant T2 as Troop2
    participant Hero as Unit(Hero)
    participant Enemy as Unit(Enemy)
    participant HeroDP as HeroDecisionProvider
    participant AiDP as AiDecisionProvider
    participant Action as Action(Skill)
    participant TargetPolicy as TargetingPolicy
    participant State as State
    participant DeathBus as DeathBus
    participant CurseTracker as CurseTracker
    participant SummonHealRule as SummonHealRule
    participant DamagePolicy as DamagePolicy

    %% éŠæˆ²åˆå§‹åŒ–éšæ®µ
    Note over Main, DamagePolicy: ğŸ® éŠæˆ²åˆå§‹åŒ–éšæ®µ
    Main->>Parser: parseInput(scanner)
    Parser->>T1: new Troop(1)
    Parser->>T2: new Troop(2)
    Parser->>Hero: new Unit(heroData)
    Parser->>Enemy: new Unit(enemyData)
    Parser->>HeroDP: new HeroDecisionProvider(decisions)
    Parser->>AiDP: new AiDecisionProvider()
    Hero->>HeroDP: setDecisionProvider(heroDP)
    Enemy->>AiDP: setDecisionProvider(aiDP)
    T1->>Hero: addUnit(hero)
    T2->>Enemy: addUnit(enemy)
    Parser->>Battle: new Battle(troop1, troop2)
    
    %% æˆ°é¬¥ç³»çµ±åˆå§‹åŒ–
    Note over Battle, SummonHealRule: ğŸ—ï¸ æˆ°é¬¥ç³»çµ±åˆå§‹åŒ– (Observer Pattern)
    Battle->>DeathBus: new DeathBus()
    Battle->>CurseTracker: new CurseTracker()
    Battle->>SummonHealRule: new SummonHealRule()
    Battle->>DeathBus: subscribe(curseTracker)
    Battle->>DeathBus: subscribe(summonHealRule)
    Battle->>DamagePolicy: new DefaultDamagePolicy()
    
    Main->>Battle: start()
    
    %% ä¸»è¦æˆ°é¬¥å¾ªç’°
    Note over Battle, DamagePolicy: âš”ï¸ å›åˆåˆ¶æˆ°é¬¥å¾ªç’°
    loop æ¯å€‹å›åˆç›´åˆ°éŠæˆ²çµæŸ
        Battle->>Battle: initializeTurnQueue()
        Battle->>Hero: poll from turnQueue
        
        %% è‹±é›„å›åˆ
        Note over Battle, DamagePolicy: ğŸ‘‘ è‹±é›„å›åˆé–‹å§‹
        Battle->>Hero: toString() [é¡¯ç¤ºç‹€æ…‹]
        Battle->>Hero: getState()
        Hero->>State: onTurnStart(hero, battle)
        
        alt è§’è‰²æœªæ­»äº¡ä¸”å¯è¡Œå‹•
            %% S1: é¸æ“‡è¡Œå‹• (Strategy Pattern)
            Note over Battle, Action: ğŸ¯ S1: é¸æ“‡è¡Œå‹• (Strategy Pattern)
            Battle->>Battle: chooseAction(hero)
            Battle->>Hero: getSkills()
            Battle->>Hero: getDecisionProvider()
            Hero->>HeroDP: chooseAction(hero, battle)
            HeroDP->>Action: é¸æ“‡æŠ€èƒ½æˆ–æ™®é€šæ”»æ“Š
            
            %% S2: é¸æ“‡ç›®æ¨™ (Strategy Pattern)
            Note over Battle, TargetPolicy: ğŸ¯ S2: é¸æ“‡ç›®æ¨™ (Strategy Pattern)
            Battle->>Battle: chooseTargets(hero, action)
            Battle->>Action: targetingPolicy()
            Action->>TargetPolicy: candidates(hero, battle)
            TargetPolicy->>Battle: getEnemiesOf(hero) æˆ–å…¶ä»–å€™é¸é‚è¼¯
            Battle->>TargetPolicy: select(hero, candidates, needed, decisionProvider)
            TargetPolicy->>HeroDP: chooseTargets(hero, candidates, needed)
            
            %% S3: åŸ·è¡Œè¡Œå‹•
            Note over Battle, DamagePolicy: âš¡ S3: åŸ·è¡Œè¡Œå‹•
            Battle->>Hero: consumeMp(action.mpCost())
            Battle->>Action: execute(hero, targets, battle)
            
            alt æ”»æ“Šé¡æŠ€èƒ½
                Action->>DamagePolicy: compute(damage, caster, target, battle)
                DamagePolicy->>Enemy: getState()
                Enemy->>State: onReceiveDamage(enemy, damage, hero, battle)
                Action->>Enemy: takeDamage(finalDamage)
                
                alt ç›®æ¨™æ­»äº¡
                    Action->>DeathBus: notifyDeath(enemy, hero, battle)
                    DeathBus->>CurseTracker: onDeath(enemy, hero, battle)
                    DeathBus->>SummonHealRule: onDeath(enemy, hero, battle)
                end
                
            else ç‹€æ…‹é¡æŠ€èƒ½ (State Pattern)
                Action->>Enemy: setState(newState)
                Enemy->>State: è¨­ç½®æ–°ç‹€æ…‹
                
            else å¬å–šæŠ€èƒ½
                Action->>Battle: å‰µå»ºæ–°çš„å²èŠå§†å–®ä½
                Action->>SummonHealRule: addSummonRelation(slime, hero)
                
            else OnePunchæŠ€èƒ½ (Chain of Responsibility)
                Note over Action, DamagePolicy: ğŸ¥Š OnePunch (Chain of Responsibility)
                loop éæ­·è¦å‰‡éˆ
                    Action->>Action: rules.applies(target, battle)
                    alt è¦å‰‡é©ç”¨
                        Action->>Action: rule.apply(caster, target, battle)
                        break
                    end
                end
            end
            
            Battle->>Battle: checkGameEnd()
            Battle->>Battle: updateStates()
        end
        
        %% AI æ•µäººå›åˆ
        Note over Battle, DamagePolicy: ğŸ¤– AI æ•µäººå›åˆ
        Battle->>Enemy: poll from turnQueue
        Battle->>Enemy: toString() [é¡¯ç¤ºç‹€æ…‹]
        Battle->>Enemy: getState()
        Enemy->>State: onTurnStart(enemy, battle)
        
        alt è§’è‰²æœªæ­»äº¡ä¸”å¯è¡Œå‹•
            %% AI æ±ºç­– (Strategy Pattern)
            Note over Battle, Action: ğŸ§  AI æ±ºç­–ç³»çµ± (Strategy Pattern)
            Battle->>Battle: chooseAction(enemy)
            Battle->>Enemy: getDecisionProvider()
            Enemy->>AiDP: chooseAction(enemy, battle)
            Note over AiDP: seed % è¡Œå‹•æ•¸é‡
            AiDP->>Action: æ ¹æ“š AI ç®—æ³•é¸æ“‡è¡Œå‹•
            
            Battle->>Battle: chooseTargets(enemy, action)
            Battle->>Action: targetingPolicy()
            Action->>TargetPolicy: candidates(enemy, battle)
            Battle->>TargetPolicy: select(enemy, candidates, needed, aiDP)
            TargetPolicy->>AiDP: chooseTargets(enemy, candidates, needed)
            Note over AiDP: (seed+i) % å€™é¸æ•¸é‡
            
            Battle->>Enemy: consumeMp(action.mpCost())
            Battle->>Action: execute(enemy, targets, battle)
            
            %% é¡ä¼¼çš„åŸ·è¡Œé‚è¼¯...
            alt æ”»æ“Šè‹±é›„
                Action->>DamagePolicy: compute(damage, enemy, hero, battle)
                Action->>Hero: takeDamage(damage)
                
                alt è‹±é›„æ­»äº¡
                    Action->>DeathBus: notifyDeath(hero, enemy, battle)
                    Battle->>Battle: checkGameEnd() [éŠæˆ²çµæŸ]
                end
            end
            
            Battle->>Battle: checkGameEnd()
            Battle->>Battle: updateStates()
        end
        
        %% ç‹€æ…‹æ›´æ–°
        Note over Battle, State: ğŸ”„ ç‹€æ…‹æ›´æ–° (State Pattern)
        loop æ‰€æœ‰å­˜æ´»è§’è‰²
            Battle->>Hero: tickState()
            Hero->>State: tickDown()
            alt ç‹€æ…‹åˆ°æœŸ
                Hero->>State: æ¢å¾©åˆ° NormalState
            end
        end
    end
    
    %% éŠæˆ²çµæŸ
    Note over Battle, Main: ğŸ éŠæˆ²çµæŸ
    alt è‹±é›„ç²å‹
        Battle->>Main: "ä½ ç²å‹äº†ï¼"
    else è‹±é›„å¤±æ•—
        Battle->>Main: "ä½ å¤±æ•—äº†ï¼"
    end

    %% è¨­è¨ˆæ¨¡å¼æ¨™è¨»
    Note over Main, DamagePolicy: ğŸ—ï¸ ä½¿ç”¨çš„è¨­è¨ˆæ¨¡å¼:<br/>Strategy Pattern: DecisionProvider, TargetingPolicy, State, DamagePolicy<br/>Observer Pattern: DeathBus, DeathListener<br/>Chain of Responsibility: OnePunchRule<br/>Factory Method: Skill creation<br/>Template Method: Action execution flow
